# 接口说明

版本：`1.0`

作者：`鲁浩`

日期：`2016.1.21`

### 统一格式：

* 状态码

    |状态码|含义|
    |---|---|
    |100|正常|
    |201|headers缺失|
    |202|非法参数|
    |203|无效apikey|
    |204|无效接口|
    |3XX|具体API定义|

* 返回格式

    ```
    {
        code: '100',
        msg: 'OK',
        data: [
            '1',
            '2',
            '3'
        ]
    }
    ```

    ```
    {
        code: '100',
        msg: 'OK',
        data: ''
    }
    ```

    ```
    {
        code: '100',
        msg: 'OK',
        data: [
            {
                'name': '1',
                'number': 1,
                'like': True
            },
            {
                'name': '2',
                'number': 2,
                'like': True
            },
            {
                'name': '3',
                'number': 3,
                'like': True
            }
        ]
    }
    ```

* 请求格式

    ```
    {
        ...
        method: 'GET',
        apikey: 'xxx',
        apiver: 1
        ...
        params {
            'lat': 1,
            'lng': 1
        }
    }
    ```

* URL

    /API/[HANDLER]/[ACTION]

### 一般规则

* 黑名单

    对每次的请求解析Host内容，并存入Redis中，如果单位时间内请求数量过多则封掉相关的IP，以防止DDos攻击。

* 缓存机制

    与用户相关或者需要加密的信息都需要利用APIkey来进行请求，而APIkey实际上就是Redis中的Key，对应的Value是User.ID。

* 数据库

    * 主要数据库Postgresql, 缓存数据库Redis。

    * 涉及到LBS相关时，使用Postgres拓展，PostGIS2进行相关处理。

    * 使用SQLAlchemy作为ORM工具进行管理，Albemic来持久化。

* 异步

    对于高延迟的操作，务必放入异步处理的队列中，即调用Celery进行后续处理。

### 模型

### 日志

### 单元测试

    * 做好对API的单元测试。

    * 所有的测试最终都应该代码化。

    * 每修复一个bug，增加一个相应的测试用例。

### 架构

    用户发送请求，请求首先经过Handler基本的参数验证，如果验证通过，则调用Model中的接口来操作数据，如果其中存在高延迟操作，则将其加入Celery中进行后续处理。

    对于APIkey的处理：用户进行登录的操作后，

### 自动化部署

    使用Farbic进行自动化的部署。

    对于定时任务使用cron进行处理。

    平台利用docker+vagrant进行统一测试和生产环境。

### 第三方服务

    * 短信平台。

    * 图片服务。

    * 推送服务。

    * 地图服务。

### 应用服务器：

* Tornado
    * 后端框架。
    * 更好地长连接，以提供持续性的服务。
    * 高并发的支持。

* Nginx
    * 部署，反向代理。

### 数据存储：

* PostgreSQL
    * 存储用户信息、多媒体的元数据、标签、路径等等。
    * 更好的GIS信息支持。

* Redis
    * 用于Feed的处理、session系统和排序系统。

* Memcached
    * 缓存数据，加速访问。

* 七牛：
    * 第三方的图片处理服务。
    * 也可以考虑自己做图片处理，把图片统一存储在价格更便宜、访问更稳定的平台。

### 任务队列/推送通知：

* Celery+Rabbitmq
    * 通过异步处理解决耗时较长的操作。
    * 例如当一个用户发布动态，将该条消息加入其关注者的Timeline。

* 极光推送
    * 第三方服务，对于Hybrid App支持较好。

###监控：

* 待定
    * 建立日志系统，收集统计信息，图形化度量。

